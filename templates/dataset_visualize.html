<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dataset Visualization - SpectraML</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/1.33.1/plotly.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="/static/js/visualization-utils.js"></script>
    <script src="/static/js/visualization-types.js"></script>
    <style>
        /* Enhanced form styles for better visibility */
        .form-control {
            @apply border-2 border-gray-300 bg-white shadow-sm rounded-md;
            @apply focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500;
        }
        
        /* Visual indicator for the selected form elements */
        select:focus, input:focus, textarea:focus {
            @apply border-indigo-500 ring-2 ring-indigo-200;
        }
        
        /* Add a subtle hover effect */
        select:hover, input:hover {
            @apply border-gray-400;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-indigo-600 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-white text-2xl font-bold">SpectraML</span>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="/" class="border-transparent text-gray-200 hover:border-gray-300 hover:text-white inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Dashboard
                        </a>
                        <a href="/experiments" class="border-transparent text-gray-200 hover:border-gray-300 hover:text-white inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Experiments
                        </a>
                    </div>
                </div>
                <div class="flex items-center">
                    <a href="/experiment/{{ experiment.id }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Experiment
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Header Section -->
        <div class="px-4 py-6 sm:px-0">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Dataset: {{ dataset.filename }}</h1>
                    <p class="mt-2 text-gray-600">Experiment: {{ experiment.name }}</p>
                </div>
            </div>
        </div>

        <!-- Data Info Section -->
        <div class="px-4 sm:px-0">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h2 class="text-lg font-medium text-gray-900">Dataset Overview</h2>
                    {% if data_info %}
                        <div class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-3">
                            <div class="bg-white overflow-hidden shadow rounded-lg border">
                                <div class="px-4 py-5 sm:p-6">
                                    <dt class="text-sm font-medium text-gray-500 truncate">Rows</dt>
                                    <dd class="mt-1 text-xl font-semibold text-gray-900">{{ data_info.num_rows }}</dd>
                                </div>
                            </div>
                            <div class="bg-white overflow-hidden shadow rounded-lg border">
                                <div class="px-4 py-5 sm:p-6">
                                    <dt class="text-sm font-medium text-gray-500 truncate">Columns</dt>
                                    <dd class="mt-1 text-xl font-semibold text-gray-900">{{ data_info.num_columns }}</dd>
                                </div>
                            </div>
                            <div class="bg-white overflow-hidden shadow rounded-lg border">
                                <div class="px-4 py-5 sm:p-6">
                                    <dt class="text-sm font-medium text-gray-500 truncate">Missing Values</dt>
                                    <dd class="mt-1 text-xl font-semibold text-gray-900">{{ data_info.missing_values }} ({{ "%.2f"|format(data_info.missing_percentage) }}%)</dd>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <p class="mt-2 text-gray-600">Unable to load data information.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Data Preview Section -->
        <div class="px-4 py-6 sm:px-0">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
                <div class="px-4 py-5 sm:px-6 flex justify-between items-center cursor-pointer" id="preview-header" onclick="togglePreviewSection()">
                    <div class="flex items-center">
                        <h2 class="text-lg leading-6 font-medium text-gray-900">Data Preview</h2>
                        <p class="mt-1 ml-2 max-w-2xl text-sm text-gray-500">Preview of the first 10 rows of the dataset</p>
                    </div>
                    <div class="flex items-center">
                        <button id="refresh-preview-btn" class="inline-flex items-center mr-3 px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200" onclick="event.stopPropagation()">
                            <i class="fas fa-sync-alt mr-1"></i> Refresh
                        </button>
                        <i id="preview-toggle-icon" class="fas fa-chevron-up text-gray-500 transition-transform duration-300"></i>
                    </div>
                </div>
                <div class="border-t border-gray-200" id="preview-content-wrapper">
                    <div id="data-preview-container" class="px-4 py-5 sm:p-6">
                        <div id="data-preview-loading" class="flex justify-center items-center py-10">
                            <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="ml-3 text-indigo-600">Loading data preview...</span>
                        </div>
                        <div id="data-preview-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                            <div class="flex">
                                <div class="py-1"><i class="fas fa-exclamation-circle text-red-500"></i></div>
                                <div class="ml-3">
                                    <p class="text-sm" id="data-preview-error-message">Error loading data preview</p>
                                </div>
                            </div>
                        </div>
                        <div id="data-preview-content" class="hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div class="text-sm text-gray-500">
                                    <span id="row-count">0</span> rows Ã— <span id="column-count">0</span> columns 
                                    (showing first <span id="preview-count">10</span> rows)
                                </div>
                                <div class="text-sm">
                                    <span id="file-type-badge" class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">CSV</span>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr id="data-preview-header"></tr>
                                    </thead>
                                    <tbody id="data-preview-body" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visualization Section -->
        <div class="px-4 sm:px-0 mt-6">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h2 class="text-lg font-medium text-gray-900">Create Visualization</h2>
                    
                    <!-- Visualization Category Tabs -->
                    <div class="mt-4 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button class="viz-category-tab border-indigo-500 text-indigo-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-category="basic">
                                Basic
                            </button>
                            <button class="viz-category-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-category="advanced">
                                Advanced
                            </button>
                            <button class="viz-category-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-category="statistical">
                                Statistical
                            </button>
                        </nav>
                    </div>
                    
                    <!-- Visualization Types Container -->
                    <!-- These will be populated by JavaScript -->
                    <div class="viz-category-content mt-4 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3" id="basic-viz"></div>
                    <div class="viz-category-content mt-4 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 hidden" id="advanced-viz"></div>
                    <div class="viz-category-content mt-4 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 hidden" id="statistical-viz"></div>
                </div>
            </div>
        </div>

        <!-- Visualization Configuration -->
        <div id="vizConfig" class="px-4 sm:px-0 mt-6 hidden">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h2 class="text-lg font-medium text-gray-900" id="configTitle">Configure Visualization</h2>
                    <form id="vizForm" class="mt-4">
                        <input type="hidden" id="vizType" name="vizType" value="">
                        <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6" id="vizFormFields">
                            <!-- Dynamic form fields will be added here by JavaScript -->
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button type="button" id="cancelVisualizationBtn" class="mr-3 inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Generate Visualization
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Visualization Result -->
        <div id="vizResult" class="px-4 sm:px-0 mt-6 hidden">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h2 class="text-lg font-medium text-gray-900">Visualization Result</h2>
                    <div id="plotContainer" class="mt-4 h-96"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white mt-10">
        <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8">
            <div class="flex justify-center space-x-6 md:order-2">
                <a href="#" class="text-gray-400 hover:text-gray-500">
                    <span class="sr-only">GitHub</span>
                    <i class="fab fa-github text-xl"></i>
                </a>
                <a href="#" class="text-gray-400 hover:text-gray-500">
                    <span class="sr-only">Twitter</span>
                    <i class="fab fa-twitter text-xl"></i>
                </a>
            </div>
            <div class="mt-8 md:mt-0 md:order-1">
                <p class="text-center text-base text-gray-400">
                    &copy; 2025 SpectraML. All rights reserved.
                </p>
            </div>
        </div>
    </footer>

    <!-- Data Preview Modal (optional) -->
    <div id="dataPreviewModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <!-- Modal content goes here -->
    </div>

    <script>
        // Data Preview Functions
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch data preview when page loads
            fetchDataPreview();
            
            // Add event listener for refresh button
            document.getElementById('refresh-preview-btn').addEventListener('click', fetchDataPreview);
            
            // Check for saved preview state and apply it
            const previewExpanded = localStorage.getItem('dataPreviewExpanded');
            if (previewExpanded === 'false') {
                togglePreviewSection(false);
            }
        });
        
        // Toggle the preview section visibility
        function togglePreviewSection(show) {
            const wrapper = document.getElementById('preview-content-wrapper');
            const toggleIcon = document.getElementById('preview-toggle-icon');
            
            if (show === undefined) {
                // Toggle based on current state
                show = wrapper.classList.contains('hidden') ? true : false;
            }
            
            if (show) {
                wrapper.classList.remove('hidden');
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
            } else {
                wrapper.classList.add('hidden');
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
            }
            
            // Save the state to localStorage
            localStorage.setItem('dataPreviewExpanded', show);
        }
        
        function fetchDataPreview() {
            const datasetId = '{{ dataset.id }}';
            const loadingElement = document.getElementById('data-preview-loading');
            const errorElement = document.getElementById('data-preview-error');
            const contentElement = document.getElementById('data-preview-content');
            
            // Show loading state
            loadingElement.classList.remove('hidden');
            errorElement.classList.add('hidden');
            contentElement.classList.add('hidden');
            
            // Make sure preview section is visible when refreshing
            togglePreviewSection(true);
            
            // Fetch data preview from API
            fetch(`/api/dataset/preview/${datasetId}`)
                .then(response => response.json())
                .then(data => {
                    // Hide loading state
                    loadingElement.classList.add('hidden');
                    
                    if (data.success) {
                        // Update dataset metadata display
                        document.getElementById('row-count').textContent = data.preview.total_rows || 0;
                        document.getElementById('column-count').textContent = data.preview.columns.length || 0;
                        document.getElementById('file-type-badge').textContent = data.dataset.filetype.toUpperCase();
                        
                        // Render the preview table
                        renderDataPreview(data.preview);
                        
                        // Show content
                        contentElement.classList.remove('hidden');
                    } else {
                        // Show error
                        document.getElementById('data-preview-error-message').textContent = 
                            data.error || 'Failed to load data preview';
                        errorElement.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    // Hide loading state and show error
                    loadingElement.classList.add('hidden');
                    document.getElementById('data-preview-error-message').textContent = 
                        'Network error while loading data preview';
                    errorElement.classList.remove('hidden');
                    console.error('Error fetching data preview:', error);
                });
        }
        
        function renderDataPreview(previewData) {
            const headerElement = document.getElementById('data-preview-header');
            const bodyElement = document.getElementById('data-preview-body');
            
            // Clear existing content
            headerElement.innerHTML = '';
            bodyElement.innerHTML = '';
            
            // Render table header
            const columns = previewData.columns || [];
            columns.forEach(column => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = column.name;
                
                // Add data type as a tooltip
                if (column.dtype) {
                    th.title = `Type: ${column.dtype}`;
                }
                
                headerElement.appendChild(th);
            });
            
            // Render table rows
            const rows = previewData.rows || [];
            rows.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                tr.className = rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                columns.forEach(column => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    
                    // Format cell value based on type
                    const value = row[column.name];
                    if (value === null || value === undefined) {
                        td.innerHTML = '<span class="text-red-500 italic">null</span>';
                    } else if (typeof value === 'object') {
                        td.textContent = JSON.stringify(value);
                    } else {
                        td.textContent = value;
                    }
                    
                    tr.appendChild(td);
                });
                
                bodyElement.appendChild(tr);
            });
            
            // Add empty state if no rows
            if (rows.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.className = 'px-6 py-4 text-center text-sm text-gray-500';
                td.colSpan = columns.length || 1;
                td.textContent = 'No data available';
                tr.appendChild(td);
                bodyElement.appendChild(tr);
            }
        }
        
        // Existing visualization code
        const vizOptions = {{ viz_options|tojson|safe if viz_options else '{}' }};
        const dataColumns = {{ data_info.columns|tojson|safe if data_info and data_info.columns else '[]' }};
        
        // Handle category tab switching
        document.querySelectorAll('.viz-category-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active tab
                document.querySelectorAll('.viz-category-tab').forEach(t => {
                    t.classList.remove('border-indigo-500', 'text-indigo-600');
                    t.classList.add('border-transparent', 'text-gray-500');
                });
                this.classList.remove('border-transparent', 'text-gray-500');
                this.classList.add('border-indigo-500', 'text-indigo-600');
                
                // Show corresponding content
                const category = this.dataset.category;
                document.querySelectorAll('.viz-category-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${category}-viz`).classList.remove('hidden');
            });
        });

        // Initialize visualization card events - needs to run after cards are created
        function initializeVisualizationCards() {
            document.querySelectorAll('.viz-type-card').forEach(card => {
                card.addEventListener('click', function() {
                    // Clear previous selection
                    document.querySelectorAll('.viz-type-card').forEach(c => {
                        c.classList.remove('ring-2', 'ring-indigo-500');
                    });
                    
                    // Highlight selected card
                    this.classList.add('ring-2', 'ring-indigo-500');
                    
                    const vizType = this.dataset.type;
                    document.getElementById('vizType').value = vizType;
                    document.getElementById('configTitle').textContent = `Configure ${vizType.replace('_', ' ').charAt(0).toUpperCase() + vizType.replace('_', ' ').slice(1)} Plot`;
                    
                    // Show configuration section and update form fields
                    document.getElementById('vizConfig').classList.remove('hidden');
                    
                    // Reset form
                    document.getElementById('vizForm').reset();
                    
                    // Hide result section
                    document.getElementById('vizResult').classList.add('hidden');
                    
                    // Generate dynamic form fields for the selected visualization type
                    generateFormFields(vizType);
                    
                    // Scroll to configuration section
                    document.getElementById('vizConfig').scrollIntoView({ behavior: 'smooth' });
                });
            });
        }
        
        // Function to generate form fields based on visualization type
        function generateFormFields(vizType) {
            const formFields = document.getElementById('vizFormFields');
            formFields.innerHTML = ''; // Clear existing fields
            
            // Add visualization type field
            const vizTypeField = document.createElement('input');
            vizTypeField.type = 'hidden';
            vizTypeField.name = 'viz_type';
            vizTypeField.value = vizType;
            formFields.appendChild(vizTypeField);
            
            // Add title field with enhanced styling
            const titleField = document.createElement('div');
            titleField.className = 'sm:col-span-6';
            titleField.innerHTML = `
                <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                <input type="text" name="title" id="title" class="mt-1 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-2 border-gray-300 bg-white rounded-md" 
                       value="${vizType.replace('_', ' ').charAt(0).toUpperCase() + vizType.replace('_', ' ').slice(1)} Visualization">
            `;
            formFields.appendChild(titleField);
            
            // Get option definitions for this visualization type
            const options = getVisualizationOptions(vizType);
            
            // Create form fields based on option definitions
            for (const [key, option] of Object.entries(options)) {
                if (key === 'title') continue; // Skip title, we already added it
                
                // Skip options that aren't meant for form display
                if (option.hidden) continue;
                
                if (option.type === 'column') {
                    addColumnSelector(formFields, key, option.label, option.required !== false);
                } 
                else if (option.type === 'multicolumn') {
                    addMultiColumnSelector(formFields, key, option.label);
                }
                else if (option.type === 'boolean') {
                    addCheckbox(formFields, key, option.label, option.default);
                }
                else if (option.type === 'number') {
                    addNumberInput(formFields, key, option.label, option.default, option.min, option.max, option.step);
                }
                else if (option.type === 'select') {
                    addSelectInput(formFields, key, option.label, option.options, option.default);
                }
            }
            
            // Add visualization-specific customizations
            addVisualizationSpecificFields(vizType, formFields);
        }
        
        // Function to get option definitions for a visualization type
        function getVisualizationOptions(vizType) {
            // Check if we have options from server
            if (vizOptions && vizOptions[vizType]) {
                return vizOptions[vizType];
            }
            
            // If not, use defaults based on visualization type
            const commonOptions = {
                title: { type: 'text', label: 'Chart Title' }
            };
            
            // Specific options for each visualization type
            if (['scatter', 'line'].includes(vizType)) {
                return {
                    ...commonOptions,
                    x: { type: 'column', label: 'X-Axis Column', required: true },
                    y: { type: 'column', label: 'Y-Axis Column', required: true },
                    color: { type: 'column', label: 'Color By (Optional)', required: false },
                    use_index: { type: 'boolean', label: 'Use Row Index for Single Column Plot', default: false }
                };
            } 
            else if (vizType === 'bar') {
                return {
                    ...commonOptions,
                    x: { type: 'column', label: 'Categories (X-Axis)', required: true },
                    y: { type: 'column', label: 'Values (Y-Axis)', required: true },
                    color: { type: 'column', label: 'Color By (Optional)', required: false }
                };
            }
            else if (vizType === 'histogram') {
                return {
                    ...commonOptions,
                    x: { type: 'column', label: 'Values Column', required: true },
                    nbins: { type: 'number', label: 'Number of Bins', default: 30, min: 5, max: 100 }
                };
            }
            else if (vizType === 'box') {
                return {
                    ...commonOptions,
                    y: { type: 'column', label: 'Values Column', required: true },
                    x: { type: 'column', label: 'Group By (Optional)', required: false }
                };
            }
            else if (vizType === 'pie') {
                return {
                    ...commonOptions,
                    x: { type: 'column', label: 'Categories Column', required: true },
                    y: { type: 'column', label: 'Values Column (numeric)', required: true }
                };
            }
            else if (vizType === 'violin') {
                return {
                    ...commonOptions,
                    y: { type: 'column', label: 'Values Column', required: true },
                    x: { type: 'column', label: 'Group By (Optional)', required: false }
                };
            }
            else if (vizType === 'heatmap') {
                return {
                    ...commonOptions,
                    x: { type: 'column', label: 'X-Axis Column', required: true },
                    y: { type: 'column', label: 'Y-Axis Column', required: true },
                    z: { type: 'column', label: 'Z Values Column (Optional)', required: false },
                    colorscale: { type: 'select', label: 'Color Scale', options: ['Viridis', 'Plasma', 'Inferno', 'Magma', 'Cividis', 'Jet'] }
                };
            }
            else if (['contour', 'density_contour'].includes(vizType)) {
                const options = {
                    ...commonOptions,
                    x: { type: 'column', label: 'X-Axis Column (Numeric)', required: true },
                    y: { type: 'column', label: 'Y-Axis Column (Numeric)', required: true },
                    colorscale: { type: 'select', label: 'Color Scale', options: ['Viridis', 'Plasma', 'Inferno', 'Magma', 'Cividis', 'Jet'] }
                };
                
                if (vizType === 'contour') {
                    options.z = { type: 'column', label: 'Z Values Column (Optional)', required: false };
                }
                
                return options;
            }
            else if (['scatter_3d', 'surface_3d'].includes(vizType)) {
                return {
                    ...commonOptions,
                    x: { type: 'column', label: 'X-Axis Column (Numeric)', required: true },
                    y: { type: 'column', label: 'Y-Axis Column (Numeric)', required: true },
                    z: { type: 'column', label: 'Z-Axis Column (Numeric)', required: true },
                    color: { type: 'column', label: 'Color By (Optional)', required: false }
                };
            }
            else if (vizType === 'parallel_coordinates') {
                return {
                    ...commonOptions,
                    columns: { type: 'multicolumn', label: 'Columns to Include' },
                    color: { type: 'column', label: 'Color By (Optional)', required: false }
                };
            }
            else if (['treemap', 'sunburst'].includes(vizType)) {
                return {
                    ...commonOptions,
                    path: { type: 'multicolumn', label: 'Hierarchy Path Columns' },
                    values: { type: 'column', label: 'Values Column (Size)', required: true },
                    color: { type: 'column', label: 'Color By (Optional)', required: false }
                };
            }
            else if (vizType === 'radar') {
                return {
                    ...commonOptions,
                    theta: { type: 'column', label: 'Categories Column', required: true },
                    r: { type: 'column', label: 'Values Column (Numeric)', required: true },
                    color: { type: 'column', label: 'Group By (Optional)', required: false }
                };
            }
            else if (vizType === 'correlation') {
                return {
                    ...commonOptions,
                    columns: { type: 'multicolumn', label: 'Columns to Correlate' },
                    show_values: { type: 'boolean', label: 'Show Values', default: true },
                    colorscale: { type: 'select', label: 'Color Scale', options: ['RdBu_r', 'Viridis', 'Plasma', 'Cividis'] }
                };
            }
            else if (vizType === 'distribution') {
                return {
                    ...commonOptions,
                    column: { type: 'column', label: 'Values Column', required: true },
                    nbins: { type: 'number', label: 'Number of Bins', default: 30, min: 5, max: 100 }
                };
            }
            else if (vizType === 'qq_plot') {
                return {
                    ...commonOptions,
                    column: { type: 'column', label: 'Values Column', required: true }
                };
            }
            else if (vizType === 'residual_plot') {
                return {
                    ...commonOptions,
                    x: { type: 'column', label: 'Predictor Column (X)', required: true },
                    y: { type: 'column', label: 'Response Column (Y)', required: true }
                };
            }
            else if (vizType === 'pair_plot') {
                return {
                    ...commonOptions,
                    columns: { type: 'multicolumn', label: 'Columns to Include' },
                    color: { type: 'column', label: 'Color By (Optional)', required: false }
                };
            }
            else if (vizType === 'cluster_map') {
                return {
                    ...commonOptions,
                    columns: { type: 'multicolumn', label: 'Columns to Include' },
                    show_values: { type: 'boolean', label: 'Show Values', default: true },
                    colorscale: { type: 'select', label: 'Color Scale', options: ['RdBu_r', 'Viridis', 'Plasma', 'Cividis'] }
                };
            }
            
            // Default options for any other type
            return {
                ...commonOptions,
                x: { type: 'column', label: 'X-Axis Column', required: true },
                y: { type: 'column', label: 'Y-Axis Column', required: true }
            };
        }
        
        // Add visualization-specific customizations to form
        function addVisualizationSpecificFields(vizType, formContainer) {
            // Add special instructions for specific chart types
            const helpText = document.createElement('div');
            helpText.className = 'sm:col-span-6 mt-2 bg-blue-50 p-3 rounded text-sm text-blue-700';
            
            if (vizType === 'scatter' || vizType === 'line') {
                helpText.innerHTML = `
                    <i class="fas fa-info-circle mr-1"></i>
                    When "Use Row Index" is checked, you only need to select either X or Y axis (not both).
                    The row index will be used for the other axis.
                `;
                formContainer.appendChild(helpText);
                
                // Add event listener to the use_index checkbox to make fields optional
                setTimeout(() => {
                    const useIndexCheckbox = document.querySelector('input[name="use_index"]');
                    if (useIndexCheckbox) {
                        useIndexCheckbox.addEventListener('change', function() {
                            const xField = document.querySelector('select[name="x"]');
                            const yField = document.querySelector('select[name="y"]');
                            
                            if (this.checked) {
                                // Make both fields optional when index is enabled
                                xField.removeAttribute('required');
                                yField.removeAttribute('required');
                                
                                // Update labels
                                document.querySelector('label[for="x"]').textContent = 'X-Axis Column (Optional if Y is selected)';
                                document.querySelector('label[for="y"]').textContent = 'Y-Axis Column (Optional if X is selected)';
                            } else {
                                // Make both fields required when index is disabled
                                xField.setAttribute('required', 'required');
                                yField.setAttribute('required', 'required');
                                
                                // Restore labels
                                document.querySelector('label[for="x"]').textContent = 'X-Axis Column';
                                document.querySelector('label[for="y"]').textContent = 'Y-Axis Column';
                            }
                        });
                    }
                }, 100);
            }
            else if (vizType === 'pie') {
                helpText.innerHTML = `
                    <i class="fas fa-info-circle mr-1"></i>
                    Pie charts require a categorical column for slices and a numeric column for values.
                `;
                formContainer.appendChild(helpText);
            }
            else if (vizType === 'heatmap') {
                helpText.innerHTML = `
                    <i class="fas fa-info-circle mr-1"></i>
                    Heatmaps show relationships between two categorical variables. If a Z-value column is not selected, the count of occurrences will be used.
                `;
                formContainer.appendChild(helpText);
            }
            else if (vizType === 'box') {
                helpText.innerHTML = `
                    <i class="fas fa-info-circle mr-1"></i>
                    Box plots show distribution statistics. The values column must be numeric. Group by column is optional.
                `;
                formContainer.appendChild(helpText);
            }
            else if (vizType === 'scatter_3d' || vizType === 'surface_3d') {
                helpText.innerHTML = `
                    <i class="fas fa-info-circle mr-1"></i>
                    3D plots require three numeric columns for X, Y, and Z axes.
                `;
                formContainer.appendChild(helpText);
            }
            else if (vizType === 'treemap' || vizType === 'sunburst') {
                helpText.innerHTML = `
                    <i class="fas fa-info-circle mr-1"></i>
                    Hierarchical visualizations require path columns (in order of hierarchy) and a numeric values column.
                `;
                formContainer.appendChild(helpText);
            }
            else if (vizType === 'correlation') {
                helpText.innerHTML = `
                    <i class="fas fa-info-circle mr-1"></i>
                    Correlation matrix shows relationships between numeric columns. If no columns are selected, all numeric columns will be used.
                `;
                formContainer.appendChild(helpText);
            }
            else if (vizType === 'pair_plot') {
                helpText.innerHTML = `
                    <i class="fas fa-info-circle mr-1"></i>
                    Pair plots create a matrix of scatterplots for multiple variables. Select 2-5 columns for best results.
                `;
                formContainer.appendChild(helpText);
            }
        }
        
        // Helper functions for form field generation
        function addColumnSelector(container, name, label, required = true) {
            const div = document.createElement('div');
            div.className = 'sm:col-span-3';
            
            div.innerHTML = `
                <label for="${name}" class="block text-sm font-medium text-gray-700">${label}</label>
                <select id="${name}" name="${name}" ${required ? 'required' : ''} class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-2 border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="">Select a column</option>
                    ${generateColumnOptions()}
                </select>
            `;
            
            container.appendChild(div);
        }
        
        function addMultiColumnSelector(container, name, label) {
            const div = document.createElement('div');
            div.className = 'sm:col-span-6';
            
            div.innerHTML = `
                <label for="${name}" class="block text-sm font-medium text-gray-700">${label}</label>
                <select id="${name}" name="${name}" multiple class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-2 border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 sm:text-sm rounded-md">
                    ${generateColumnOptions(false, true)}
                </select>
                <p class="mt-1 text-xs text-gray-500">Hold Ctrl/Cmd to select multiple columns</p>
            `;
            
            container.appendChild(div);
        }
        
        function addCheckbox(container, name, label, checked = false) {
            const div = document.createElement('div');
            div.className = 'sm:col-span-6';
            
            div.innerHTML = `
                <div class="flex items-center">
                    <input id="${name}" name="${name}" type="checkbox" ${checked ? 'checked' : ''} class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="${name}" class="ml-2 block text-sm text-gray-700">
                        ${label}
                    </label>
                </div>
            `;
            
            container.appendChild(div);
        }
        
        function addNumberInput(container, name, label, defaultValue = '', min = '', max = '', step = '') {
            const div = document.createElement('div');
            div.className = 'sm:col-span-3';
            
            div.innerHTML = `
                <label for="${name}" class="block text-sm font-medium text-gray-700">${label}</label>
                <input type="number" id="${name}" name="${name}" value="${defaultValue}"
                    ${min !== '' ? `min="${min}"` : ''} 
                    ${max !== '' ? `max="${max}"` : ''} 
                    ${step !== '' ? `step="${step}"` : ''} 
                    class="mt-1 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-2 border-gray-300 bg-white rounded-md">
            `;
            
            container.appendChild(div);
        }
        
        function addSelectInput(container, name, label, options = [], defaultValue = '') {
            const div = document.createElement('div');
            div.className = 'sm:col-span-3';
            
            let optionsHtml = '';
            options.forEach(option => {
                optionsHtml += `<option value="${option}" ${option === defaultValue ? 'selected' : ''}>${option}</option>`;
            });
            
            div.innerHTML = `
                <label for="${name}" class="block text-sm font-medium text-gray-700">${label}</label>
                <select id="${name}" name="${name}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-2 border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 sm:text-sm rounded-md">
                    ${optionsHtml}
                </select>
            `;
            
            container.appendChild(div);
        }
        
        function generateColumnOptions(numericOnly = false, addDataType = false) {
            if (!dataColumns || !dataColumns.length) {
                return '<option value="" disabled>No columns available</option>';
            }
            
            let options = '';
            dataColumns.forEach(column => {
                // Check if we should only show numeric columns
                const isNumeric = column.dtype.includes('int') || column.dtype.includes('float');
                if (numericOnly && !isNumeric) return;
                
                const displayName = addDataType ? `${column.name} (${column.dtype})` : column.name;
                options += `<option value="${column.name}">${displayName}</option>`;
            });
            
            return options;
        }
        
        // Handle cancel button click
        document.getElementById('cancelVisualizationBtn').addEventListener('click', function() {
            // Hide configuration and result sections
            document.getElementById('vizConfig').classList.add('hidden');
            document.getElementById('vizResult').classList.add('hidden');
            
            // Clear selection
            document.querySelectorAll('.viz-type-card').forEach(c => {
                c.classList.remove('ring-2', 'ring-indigo-500');
            });
            
            // Reset form
            document.getElementById('vizForm').reset();
        });
        
        // Handle visualization form submission
        document.getElementById('vizForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            document.getElementById('vizResult').classList.remove('hidden');
            document.getElementById('plotContainer').innerHTML = '<div class="flex justify-center items-center h-full"><i class="fas fa-spinner fa-spin text-indigo-500 text-3xl"></i></div>';
            
            // Collect form data
            const formData = new FormData(this);
            const vizType = document.getElementById('vizType').value;
            
            // Convert form data to object
            const params = {};
            for (const [key, value] of formData.entries()) {
                // Handle multi-select fields
                if (key.endsWith('[]')) {
                    const cleanKey = key.slice(0, -2);
                    if (!params[cleanKey]) {
                        params[cleanKey] = [];
                    }
                    params[cleanKey].push(value);
                } 
                else if (key === 'use_index') {
                    // Convert checkbox to boolean
                    params[key] = true;
                }
                else {
                    params[key] = value;
                }
            }
            
            // Prepare request data
            const requestData = {
                filename: '{{ dataset.filename }}',
                viz_type: vizType,
                params: params
            };
            
            console.log("Sending visualization request:", requestData);
            
            // Scroll to result section
            document.getElementById('vizResult').scrollIntoView({ behavior: 'smooth' });
            
            // Make API request
            fetch('/api/visualize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showPlotError('plotContainer', data.error);
                    return;
                }
                
                try {
                    // Use the visualization utilities to render the plot
                    renderPlot('plotContainer', data.plot)
                        .catch(err => {
                            console.error("Error rendering plot:", err);
                            showPlotError('plotContainer', `Error rendering visualization: ${err.message}`);
                        });
                } catch (error) {
                    console.error('Error rendering visualization:', error);
                    showPlotError('plotContainer', 'Error rendering visualization');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showPlotError('plotContainer', `Error creating visualization: ${error.message}`);
            });
        });

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Populate visualization cards from visualization-types.js
            populateVisualizations();
            
            // After cards are created, initialize their event handlers
            setTimeout(() => {
                initializeVisualizationCards();
            }, 100);
        });
        
        // Function to show error messages in plot container
        function showPlotError(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center text-red-500">
                            <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                            <p>${message}</p>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
